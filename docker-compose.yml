services:
  searxng:
    user: root
    image: 'ghcr.io/searxng/searxng:latest'
    container_name: searxng
    restart: unless-stopped
    sysctls:
      - net.ipv4.ip_default_ttl=128
      - net.ipv4.tcp_timestamps=0
    depends_on:
      - valkey
      - 4get-hijacked
      - flaresolverr
    environment:
      - SEARXNG_OUTGOING_HTTP_PROTOCOL_DISABLED=false
      - SEARXNG_OUTGOING_ALLOW_PRIVATE_NETWORKS=true
      - PYTHONPATH=/usr/local/searxng/searx/engines
      - 'INSTANCE_NAME=${INSTANCE_NAME}'
      - 'SEARXNG_BASE_URL=https://${SERVICE_FQDN_SEARXNG}'
      - 'SEARXNG_SECRET=${SERVICE_PASSWORD_SEARXNGSECRET}'
      - 'SEARXNG_REDIS_URL=valkey://valkey:6379/0'
      - 'SEARXNG_VALKEY_URL=valkey://valkey:6379/0'
    volumes:
      - './searx/engines:/tmp/custom-engines:ro'
    networks:
      - searxng-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8080/healthz || exit 1" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    entrypoint:
      - /bin/sh
      - '-c'
      - "echo \"--- CUSTOM STARTUP SCRIPT STARTED ---\"


        if [ -d '/tmp/custom-engines' ]; then

        \    echo \"Found custom engines directory. Copying...\"

        \    cp -fv /tmp/custom-engines/*.py /usr/local/searxng/searx/engines/

        \   \ 

        \    echo \"Fixing permissions...\"

        \    chown searxng:searxng /usr/local/searxng/searx/engines/*.py

        \   \ 

        \    echo \"Verifying copy:\"

        \    ls -la /usr/local/searxng/searx/engines/*-4get.py

        else

        \    echo \"ERROR: /tmp/custom-engines directory not found!\"

        \    ls -la /tmp/

        fi


        echo \"--- HANDING OVER TO ORIGINAL ENTRYPOINT ---\"

        # We manually execute the original entrypoint to start the app

        exec /usr/local/searxng/entrypoint.sh\n"
  valkey:
    container_name: valkey
    image: 'docker.io/valkey/valkey:alpine'
    command: 'valkey-server --save 60 1 --loglevel warning'
    restart: unless-stopped
    volumes:
      - 'valkey-data:/data'
    networks:
      - searxng-net
  4get-hijacked:
    build:
      context: ./sidecar
    container_name: 4get-hijacked
    ports:
      - '8081:80'
    restart: unless-stopped
    sysctls:
      - net.ipv4.ip_default_ttl=128
      - net.ipv4.tcp_timestamps=0
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost/health.php || exit 1" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - searxng-net
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
      - TZ=UTC
    ports:
      - "8191:8191"
    restart: unless-stopped
    sysctls:
      - net.ipv4.ip_default_ttl=128
      - net.ipv4.tcp_timestamps=0
    networks:
      - searxng-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8191/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  searxng-net:
    driver: bridge
volumes:
  valkey-data: null
